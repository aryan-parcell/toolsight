import { doc, updateDoc } from 'firebase/firestore';
import { db, State, signIn, section, pass, fail, info } from '../helpers';

export const run = async () => {
  section("5. SECURITY EXPLOITS");

  const maintainer = State.users.find((u: any) => u.email.includes('maintainer-alpha'));
  await signIn(maintainer.email);

  // 1. Attack: Privilege Escalation
  info("Attack: Maintainer changing role to 'admin'...");
  try {
    await updateDoc(doc(db, 'users', maintainer.uid), { role: 'admin' });
    fail("Exploit Successful! User changed their own role.");
  } catch (e: any) {
    if (e.code === 'permission-denied') pass("Role change blocked");
    else throw e;
  }

  // 2. Attack: Org Jumping
  info("Attack: Maintainer changing Org ID...");
  try {
    await updateDoc(doc(db, 'users', maintainer.uid), { organizationId: State.betaId });
    fail("Exploit Successful! User changed their Org ID.");
  } catch (e: any) {
    if (e.code === 'permission-denied') pass("Org Jump blocked");
    else throw e;
  }
};